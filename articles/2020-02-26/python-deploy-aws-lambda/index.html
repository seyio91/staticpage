
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://www.seyiobaweya.tech/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://www.seyiobaweya.tech/theme/pygments/monokai.min.css">
  <link rel="stylesheet" type="text/css" href="https://www.seyiobaweya.tech/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://www.seyiobaweya.tech/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://www.seyiobaweya.tech/theme/font-awesome/css/solid.css">

    <link href="https://www.seyiobaweya.tech/static/custom.css" rel="stylesheet">

    <link href="https://www.seyiobaweya.tech/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Seyi Obaweya Atom">


    <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon">
    <link rel="icon" href="images/favicon.png" type="image/x-icon">

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-156544577-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->
    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#C0C0C0">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#C0C0C0">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#C0C0C0">

<meta name="author" content="Seyi Obaweya" />
<meta name="description" content="After successfully creating our script, we will be using the AWS Lambda service to deploy the script. This article walks you through the process of setting up the lambda function." />
<meta name="keywords" content="python, aws, webscraping, lambda">


<meta property="og:site_name" content="Seyi Obaweya"/>
<meta property="og:title" content="Deploying your Python Script to Lambda - Part 2"/>
<meta property="og:description" content="After successfully creating our script, we will be using the AWS Lambda service to deploy the script. This article walks you through the process of setting up the lambda function."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://www.seyiobaweya.tech/articles/2020-02-26/python-deploy-aws-lambda/"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2020-02-26 10:20:00+00:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://www.seyiobaweya.tech/author/seyi-obaweya.html">
<meta property="article:section" content="Python_Automation"/>
<meta property="article:tag" content="python"/>
<meta property="article:tag" content="aws"/>
<meta property="article:tag" content="webscraping"/>
<meta property="article:tag" content="lambda"/>
<meta property="og:image" content="http://localhost:8000/images/site_logo.jpeg">

  <title>Seyi Obaweya &ndash; Deploying your Python Script to Lambda - Part 2</title>

</head>
<body>

<div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v5.0"></script>  
  <aside>
    <div>
      <h1><a href="https://www.seyiobaweya.tech">Musings of an Engineer</a></h1>

<p>Tech Lover</p>

      <!-- <span class="toggler" id="toggler" style="display: none;"><i class="fas fa-bars"></i> MENU</span> -->
      <span class="toggler" id="toggler"><i class="fas fa-bars"></i> MENU</span>
      <nav id="navid">
        <ul class="list">

            <li class="navlist"><a href="https://www.seyiobaweya.tech">Home</a></li>
            <li class="navlist"><a target="_blank" href="https://www.seyiobaweya.tech/pages/about-me.html">About seyi</a></li>


        </ul>
      </nav>
    <!-- </div> -->

      <ul class="social" id="social">
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/obaweya-seyi-375270ba" target="_blank">
            <i class="fab fa-linkedin">
            </i>
          </a></li>
          <li>
            <a  class="sc-github" href="https://github.com/seyio91" target="_blank">
            <i class="fab fa-github">
            </i>
          </a></li>
      </ul>
    </div>

  
<div class="card">
    <div class="card-header">
      <i class="fas fa-folder"></i> Categories
    </div>
    <div class="card-body">
    <ul class="recent">
      <li><a href="https://www.seyiobaweya.tech/category/bash_automation.html"><i class="fas fa-folder-open"></i>  Bash_Automation</a> (1)</li>
      <li><a href="https://www.seyiobaweya.tech/category/python_automation.html"><i class="fas fa-folder-open"></i>  Python_Automation</a> (2)</li>
      <li><a href="https://www.seyiobaweya.tech/category/web_development.html"><i class="fas fa-folder-open"></i>  Web_Development</a> (2)</li>
    </ul>
  </div>
  </div>
  
<div class="card">
    <div class="card-header">
      <i class="fas fa-folder"></i> Tags
    </div>
    <div class="card-body">
      <div class="tag-block">
          <a href="https://www.seyiobaweya.tech/tag/api.html" style="font-size: 100.0%;">api</a>
          <a href="https://www.seyiobaweya.tech/tag/aws.html" style="font-size: 100.0%;">aws</a>
          <a href="https://www.seyiobaweya.tech/tag/bash.html" style="font-size: 100.0%;">bash</a>
          <a href="https://www.seyiobaweya.tech/tag/cron.html" style="font-size: 100.0%;">cron</a>
          <a href="https://www.seyiobaweya.tech/tag/git.html" style="font-size: 100.0%;">git</a>
          <a href="https://www.seyiobaweya.tech/tag/lambda.html" style="font-size: 100.0%;">lambda</a>
          <a href="https://www.seyiobaweya.tech/tag/pelican.html" style="font-size: 125.0%;">pelican</a>
          <a href="https://www.seyiobaweya.tech/tag/python.html" style="font-size: 150.0%;">python</a>
          <a href="https://www.seyiobaweya.tech/tag/webscraping.html" style="font-size: 125.0%;">webscraping</a>
      </div>
  </div>
  </div>
<div class="card">
    <div class="card-header">
      Most Recent Posts
    </div>
    <div class="card-body">
    <ul class="recent">
        <li><a href="https://www.seyiobaweya.tech/articles/2020-02-26/python-deploy-aws-lambda/"><i class="fas fa-link"></i> Deploying your Python Script to Lambda - Part 2</a></li>
        <li><a href="https://www.seyiobaweya.tech/articles/2020-02-25/python-love-poem/"><i class="fas fa-link"></i> Creating a Python Love Poem</a></li>
        <li><a href="https://www.seyiobaweya.tech/articles/2020-01-28/customizing-your-site/"><i class="fas fa-link"></i> Customizing your Pelican Static Site</a></li>
        <li><a href="https://www.seyiobaweya.tech/articles/2020-01-20/personal-website-setup/"><i class="fas fa-link"></i> Creating a Personal Static Website with Pelican</a></li>
        <li><a href="https://www.seyiobaweya.tech/articles/2020-01-17/new-project-script/"><i class="fas fa-link"></i> Automating Project Setup with Bash</a></li>
    </ul>
  </div>
  </div>

  </aside>
  <main id="main">

    <nav>
      <a href="https://www.seyiobaweya.tech">    Home
</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://www.seyiobaweya.tech/feeds/all.atom.xml">    Atom
</a>

    </nav>

<article class="single">
  <header>
      
    <b><h1 id="python-deploy-aws-lambda">Deploying your Python Script to Lambda - Part 2</h1></b>
    <p>
          Posted on Wed 26 February 2020 in <a href="https://www.seyiobaweya.tech/category/python_automation.html">Python_Automation</a>


    </p>
    
  </header>


  <div>
    <p>This is the second article in the 2 part series "Creating a Python Love Poem". This Article covers deploying your Python script to AWS Lambda Service.</p>
<h1></h1>
<ol>
<li><a href="https://www.seyiobaweya.tech/articles/2020-02-25/python-love-poem/">Setting Up Pelican Site Generator</a></li>
<li><strong>Deploying your Python Script to Lambda</strong> &lt;-- this article</li>
</ol>
<h1></h1>
<p align="center">
<figure>
  <img src="/images/pythonawslambda.png" alt="AWS Lambda Functions and Python">
</figure> 
</p>

<h1></h1>
<p>In <a href="https://www.seyiobaweya.tech/articles/2020-02-25/python-love-poem/"><strong>Part One</strong></a>, our code has been tested and is ready for deployment. With the advent of serverless computing, it would be a waste of resources to run a task as small as this. Here is Where AWS Lambda comes in.<br>
AWS Lambda Service is a serverless cloud computing service that runs small pieces of code/ functions without the need for a server making you only pay for the compute time you consume. Also, Aws lambda service gives a million requests for free in a month. making it perfect as we would be making less than 100 requests for this project  </p>
<h3>Creating your Lambda Function</h3>
<p><strong>You'll need to have an AWS account to run this project.</strong></p>
<h1></h1>
<ul>
<li>Sign in to your AWS console.  </li>
<li>Under Services, Select Lambda service under the Compute Category   </li>
<li>Click on <code>Create Function</code>  </li>
<li>Enter the Name of the New Function  </li>
<li>Specify the Runtime Environment of the Function  </li>
</ul>
<p>The Function runtimes are the languages and versions supported by AWS and are used for the execution of the function. Your function runtime version should be similar to your development environment. Our script is written in python and we can check the closest version by running the following  command on our development terminal</p>
<div class="highlight"><pre><span></span>$ python --version

Python <span class="m">3</span>.6.2
</pre></div>


<p>Select the closest Runtime to your Python version to your development environment</p>
<h1></h1>
<p><p align="center">
<figure>
  <img src="/images/create_function.JPG" alt="Creating a Function"  class="enableModal">
  <figcaption style="text-align: center;">Figure 1. Creating a Function.</figcaption>
</figure> 
</p></p>
<h1></h1>
<h1></h1>
<p>You are now redirected to a Designer page which shows you an overview of your function. The Designer Page is used for function configuration such as adding Event Triggers, Layers and other Actions related to other AWS services. Below the Designer, you have the code Editor which displays a default function structure, the code editor allows you to make changes to your function on the AWS console.</p>
<div class="highlight"><pre><span></span>import json

def lambda_handler<span class="o">(</span>event, context<span class="o">)</span>:
    <span class="c1"># TODO implement</span>
    <span class="k">return</span> <span class="o">{</span>
        <span class="s1">&#39;statusCode&#39;</span>: <span class="m">200</span>,
        <span class="s1">&#39;body&#39;</span>: json.dumps<span class="o">(</span><span class="s1">&#39;Hello from Lambda!&#39;</span><span class="o">)</span>
    <span class="o">}</span>
</pre></div>


<h1></h1>
<p>The Lambda function takes in a function handler <code>lambda_handler(event, context)</code> which has 2 arguments <code>event</code> and <code>context</code>. The event parameter is used to pass data into your function, while the context provides the runtime information to the function. The Handler acts as an entry point for your function, which is similar to the <code>if __name__ == "__main__"</code> line in python used to ensure a block of code executes when a script is run on the command-line. The Handler also returns JSON-formatted data.</p>
<h1></h1>
<p><p align="center">
<figure>
  <img src="/images/step20.JPG" alt="Function Homepage"  class="enableModal">
  <figcaption style="text-align: center;">Figure 2. Designer Page.</figcaption>
</figure> 
</p></p>
<h1></h1>
<h1></h1>
<h3>Installing Dependencies</h3>
<h1></h1>
<p>AWS provides a list of available Python libraries that can be imported into your project, however you start to encounter issues when you need libraries that are not available by default such as the Twilio and BeautifulSoup Libraries used in our script. To make deployments easier AWS lambda service allows users to install libraries locally and upload as Lambda Layers.  </p>
<p><strong>Lambda Layers</strong>  </p>
<h1></h1>
<p>A Lambda Layer is a ZIP archive that contains libraries. Layers are very useful if you have various Lambda functions using the same dependencies since the dependencies will be imported into the Lambda function at runtime. The main benefit of this is that you utilize your dependencies more efficiently, resulting in smaller deployment bundles that make deployments faster.  </p>
<p>To create a Layer, The Python dependencies will be installed to a directory, which will then be zipped and uploaded as a Lambda layer. 
Note, when a Layer ZIP archive is loaded into AWS Lambda, it is unzipped to the /opt folder. The Libraries should be placed inside a <code>python</code> directory to enable the Python lambda function to import the library.</p>
<p>Create a directory named python to hold your dependencies  </p>
<div class="highlight"><pre><span></span>mkdir python
</pre></div>


<p>Install all dependencies to the directory with the <code>-t</code> flag<br>
<code>pip install &lt;dependency-name&gt; -t python</code></p>
<div class="highlight"><pre><span></span>pip install Twilio requests -t python
</pre></div>


<p>Compress the python directory into a zip file<br>
N.B. Install zip utility if not present on your system. <code>apt-get install zip</code></p>
<div class="highlight"><pre><span></span>zip -r twiliodeps.zip python
</pre></div>


<p>to upload, you can use the AWS CLI or the AWS console</p>
<div class="highlight"><pre><span></span>aws lambda publish-layer-version --layer-name twiliodep --zip-file fileb://twiliodeps.zip
</pre></div>


<p>The Created Zip file can also be uploaded on the AWS Console  </p>
<h1></h1>
<ul>
<li>On your Lambda Service Console, Click on Layers  </li>
<li>Give your Layer a Unique Name and a Description (optional)  </li>
<li>Select Upload a .zip file  </li>
<li>Click Upload a File and Select your Zipped File  </li>
<li>Choose Compatible Runtime (similar Runtime to your development environment)  </li>
<li>Create  </li>
</ul>
<h1></h1>
<p><p align="center">
<figure>
  <img src="/images/layers1.JPG" alt="Creating a Layer"  class="enableModal">
  <figcaption style="text-align: center;">Figure 3. Creating a Layer.</figcaption>
</figure> 
</p></p>
<h1></h1>
<p>After creating and Uploading your Layers, the dependencies can be imported in the script</p>
<h1></h1>
<ul>
<li>On the Designer, Click on Layers,</li>
<li>A Layers section will appear below the designer. </li>
<li>Click <code>Add a Layer</code> which takes you to a page where you can select a layer to add</li>
<li>Select the Layer you earlier created and Add.</li>
</ul>
<h1></h1>
<p><p align="center">
<figure>
  <img src="/images/add_layer2.JPG" alt="Adding Layers to Lambda Function"  class="enableModal">
  <figcaption style="text-align: center;">Figure 4. Adding Layers to Lambda Function.</figcaption>
</figure> 
</p></p>
<h1></h1>
<p>On adding the Layer, the Designer shows the number of layers attached to your function</p>
<p>we can then test if layers are imported by importing our dependencies into the function</p>
<div class="highlight"><pre><span></span>import json
from twilio.rest import Client
from bs4 import BeautifulSoup as bs

def lambda_handler<span class="o">(</span>event, context<span class="o">)</span>:
    <span class="c1"># TODO implement</span>
    <span class="k">return</span> <span class="o">{</span>
        <span class="s1">&#39;statusCode&#39;</span>: <span class="m">200</span>,
        <span class="s1">&#39;body&#39;</span>: json.dumps<span class="o">(</span><span class="s1">&#39;Hello from Lambda!&#39;</span><span class="o">)</span>
    <span class="o">}</span>
</pre></div>


<p>Save the function to add the dependencies and click on the <code>test</code> button above the designer.
On your first run, you are prompted to create a default test event. Accept the Default Settings as we do not have any event being passed into our function.
Click the Test Button again</p>
<p>if the layer was properly uploaded, the console returns a succeeded Status</p>
<h1></h1>
<p><figure>
  <img src="/images/success.JPG" alt="Test Success" align="center"  class="enableModal">
  <figcaption style="text-align: center;">Figure 5. Test Success.</figcaption>
</figure> </p>
<h1></h1>
<h3>Adding our code to the Lambda Function</h3>
<h1></h1>
<p>The functions are added above the main lambda handler, while the body for running our code will be included in the handler which is called at runtime. We also wrapped our code in a try/except block to catch errors raised.</p>
<p>Our new code is</p>
<div class="highlight"><pre><span></span>import json, sys, requests
import urllib.parse, boto3, random
from bs4 import BeautifulSoup as bs

def getMessage<span class="o">()</span>:
    ...


def _get_request<span class="o">(</span>url, payload<span class="o">)</span>:
    ...

<span class="nv">transUrl</span> <span class="o">=</span> <span class="s1">&#39;https://translation.googleapis.com/language/translate/v2&#39;</span>
<span class="nv">randomLangUrl</span> <span class="o">=</span> <span class="s1">&#39;https://translation.googleapis.com/language/translate/v2/languages&#39;</span>

def lambda_handler<span class="o">(</span>event, context<span class="o">)</span>:
    <span class="c1"># TODO implement</span>
    try:
        <span class="nv">client</span> <span class="o">=</span> Client<span class="o">(</span>twiliosid, twiliotoken<span class="o">)</span>

        ...

        <span class="nv">transResponse</span> <span class="o">=</span> _get_request<span class="o">(</span>transUrl, transPayload<span class="o">)</span>
        <span class="nv">msg</span> <span class="o">=</span> transResponse.get<span class="o">(</span><span class="s1">&#39;data&#39;</span><span class="o">)</span>.get<span class="o">(</span><span class="s1">&#39;translations&#39;</span><span class="o">)[</span><span class="m">0</span><span class="o">]</span>.get<span class="o">(</span><span class="s1">&#39;translatedText&#39;</span><span class="o">)</span>

        <span class="nv">msg</span> <span class="o">=</span> translate<span class="o">(</span><span class="s1">&#39;I Love You&#39;</span>, <span class="s1">&#39;en&#39;</span>, dest_language, gtranslateApiKey<span class="o">)</span>
        <span class="nv">randomQuote</span> <span class="o">=</span> getMessage<span class="o">()</span>
        <span class="nv">fulltextmsg</span> <span class="o">=</span> randomQuote + <span class="s2">&quot; \n P.S. &quot;</span> + msg

        <span class="nv">loved_ones</span> <span class="o">=</span> <span class="o">{</span><span class="s1">&#39;seyi&#39;</span>: <span class="s1">&#39;+26878514450&#39;</span><span class="o">}</span>

        <span class="k">for</span> key, value in loved_ones.items<span class="o">()</span>:
            <span class="nv">message</span> <span class="o">=</span> client.messages.create<span class="o">(</span>
                                        <span class="nv">body</span><span class="o">=</span><span class="s2">&quot;Dear &quot;</span> + key + <span class="s2">&quot;,\n&quot;</span> + fulltextmsg,
                                        <span class="nv">from_</span><span class="o">=</span><span class="s1">&#39;whatsapp:+14155238886&#39;</span>,
                                        <span class="nv">to</span><span class="o">=</span><span class="s1">&#39;whatsapp:&#39;</span> + value
                                    <span class="o">)</span>

        <span class="k">return</span> <span class="o">{</span>
            <span class="s1">&#39;statusCode&#39;</span>: <span class="m">200</span>,
            <span class="s1">&#39;body&#39;</span>: message.sid
        <span class="o">}</span>
    except:
        <span class="k">return</span> <span class="o">{</span>
            <span class="s1">&#39;statusCode&#39;</span>: <span class="m">400</span>,
            <span class="s1">&#39;body&#39;</span>: <span class="s1">&#39;Error, Bad Request&#39;</span>
        <span class="o">}</span>
</pre></div>


<h3>Managing Secrets on Lambda</h3>
<h1></h1>
<p>In the previous part, we saw the importance of managing application secrets and were able to secure our secrets by using the .dotenv package and OS environment variables. We would be using the AWS Parameter Store to securely manage our API keys </p>
<blockquote>
<p>AWS Systems Manager Parameter Store provides secure, hierarchical storage for configuration data management and secrets management. You can store data such as passwords, database strings, and license codes as parameter values.  </p>
</blockquote>
<p>We would be storing our API keys by encrypting them in the parameter store and only importing it to our script during runtime.  </p>
<h1></h1>
<ul>
<li>Sign in to your AWS Console and select an appropriate region.  </li>
<li>Under Services, click on Systems Manager.  </li>
<li>on the left menu pane, scroll down to the Parameter Store  </li>
<li>Click on Create Parameter in the new window  </li>
</ul>
<p>There are 3 types of Parameters</p>
<h1></h1>
<ol>
<li>Strings</li>
<li>Secure String which would be used to encrypt our API keys using a KMS key that can be decrypted only by a permitted user  </li>
<li>String List  </li>
</ol>
<p>We then proceed to create parameters for our google and Twilio API keys  </p>
<h1></h1>
<ul>
<li>Enter the Name of the keys you want to store. Example GAPIkey</li>
<li>Enter the Description(Optional)  </li>
<li>Select Secure String as Parameter Type. Under KMS key source select My current account if you want to use the KMS key present in your account.  </li>
<li>From the drop-down list select the KMS Key ID you want to use to encrypt the values.  </li>
<li>Enter the Value which you need to store and click on the Create Parameter.  </li>
</ul>
<p>After creating your keys, your parameter store should contain all 3 keys</p>
<h1></h1>
<p><p align="center">
<figure>
  <img src="/images/step9.PNG" alt="Parameter Store"  class="enableModal">
  <figcaption style="text-align: center;">Figure 6. Parameter Store.</figcaption>
</figure> 
</p></p>
<h1></h1>
<p>You can also go into a key and view the decrypted value if signed in as a permitted user</p>
<h1></h1>
<p><p align="center">
<figure>
  <img src="/images/step10.PNG" alt="Secured Key View"  class="enableModal">
  <figcaption style="text-align: center;">Figure 7. Secured Key View.</figcaption>
</figure> 
</p></p>
<h1></h1>
<p>A Faster approach to creating our parameters is by using the AWS CLI.</p>
<p>Make sure your AWS CLI is configured to use your credentials</p>
<div class="highlight"><pre><span></span>aws configure
</pre></div>


<p>Creating SecureString Parameter</p>
<div class="highlight"><pre><span></span>aws ssm put-parameter --name googleTranslateKey --type secureString --value &lt;your-key&gt;
</pre></div>


<p>Creating String Parameter</p>
<div class="highlight"><pre><span></span>aws ssm put-parameter --name twiliosid --type string --value &lt;your-key&gt;
</pre></div>


<p>Retrieving the Keys</p>
<div class="highlight"><pre><span></span>aws ssm get-parameter --name googleTranslateKey
</pre></div>


<p>this returns a python dictionary which contains the string if the value is a plaintext string, while it returns an encrypted key for secureString</p>
<p>to decrypt, pass the with-decrypt flag</p>
<div class="highlight"><pre><span></span>aws ssm get-parameter --name googleTranslateKey  --with-decrypt
</pre></div>


<p>Incorporating into our code
The keys will be imported into our function using the AWS SDK boto3, which allows us to make use of other AWS services such as s3, parameter store and Amazon EC2  in our function.</p>
<div class="highlight"><pre><span></span>import boto3

<span class="nv">ssm</span> <span class="o">=</span> boto3.client<span class="o">(</span><span class="s1">&#39;ssm&#39;</span><span class="o">)</span>

def _getParameter<span class="o">(</span>someString<span class="o">)</span>:
    <span class="nv">paramObject</span> <span class="o">=</span> ssm.get_parameter<span class="o">(</span><span class="nv">Name</span><span class="o">=</span>someString, <span class="nv">WithDecryption</span><span class="o">=</span>True<span class="o">)</span>
    <span class="k">return</span> paramObject<span class="o">[</span><span class="s1">&#39;Parameter&#39;</span><span class="o">][</span><span class="s1">&#39;Value&#39;</span><span class="o">]</span>
</pre></div>


<p>We import the boto3 library, then create a client for the ssm service.
The next line creates the <code>_getParameter</code> function which takes in a Parameter name, and returns the decrypted value using the ssm client that was created.</p>
<p>Retrieving the Keys with the _getParameter function in the Lambda handler</p>
<div class="highlight"><pre><span></span><span class="nv">gtranslateApiKey</span> <span class="o">=</span> _getParameter<span class="o">(</span><span class="s1">&#39;GtranslateApiKey&#39;</span><span class="o">)</span>
<span class="nv">twiliotoken</span> <span class="o">=</span> _getParameter<span class="o">(</span><span class="s1">&#39;valapptokentwilio&#39;</span><span class="o">)</span>
<span class="nv">twiliosid</span> <span class="o">=</span> _getParameter<span class="o">(</span><span class="s1">&#39;whatsappsidtwilio&#39;</span><span class="o">)</span>
</pre></div>


<h3>Adding Roles to your Function</h3>
<h1></h1>
<p>Save and Run your code after including the Secured keys, We however, get an <code>AccessDeniedException</code> when the script tries to access the keys we created</p>
<h1></h1>
<p><p align="center">
<figure>
  <img src="/images/permission_error.JPG" alt="Console Error"  class="enableModal">
  <figcaption style="text-align: center;">Figure 8. Console Error.</figcaption>
</figure> 
</p></p>
<h1></h1>
<p>The error occurs because we initially chose the default execution role which only provides access to the Lambda service and we now have included the System Manager and KMS service into our function, and the default Role does not have permission to run those services. we would work around this by creating a new IAM role which gives our function access to the KMS service to decrypt our secret API keys</p>
<p><strong>IAM Roles</strong>  </p>
<h1></h1>
<blockquote>
<p><strong>"IAM roles are a secure way to grant permissions to entities that you trust"</strong>   </p>
</blockquote>
<h1></h1>
<p>such as an AWS service that needs to act on resources in your account to provide its features. </p>
<h4>Creating Roles in AWS</h4>
<h1></h1>
<ul>
<li>Navigate to the IAM Service</li>
<li>Click Create Roles</li>
<li>Select AWS Service as the type of trusted entity</li>
<li>Select Lambda Use Case and Click on Permissions Button</li>
</ul>
<h1></h1>
<p><p align="center">
<figure>
  <img src="/images/step13.PNG" alt="Creating a Role"  class="enableModal">
  <figcaption style="text-align: center;">Figure 9. Creating a Role.</figcaption>
</figure> 
</p></p>
<h1></h1>
<p>You will be prompted to create a policy that will be attached to the role being created. Policies are Objects that define permissions for specific AWS resources and services.<br>
We would be creating Policies and attaching the Listed Permissions </p>
<h1></h1>
<dl>
<dd>Service: Lambda  </dd>
<dd>Action: Read  </dd>
<dd>Resources: All  </dd>
</dl>
<p>This will grant the policy user access run the Lambda function, Also add the KMS service with Decrypt access for decrypting our keys and System Manager service with the ReadParameters Access for reading keys from the Parameter Store</p>
<h1></h1>
<dl>
<dd>Service: KMS  </dd>
<dd>Action: Decrypt  </dd>
<dd>Resources: All  </dd>
</dl>
<h1></h1>
<dl>
<dd>Service: System Manager  </dd>
<dd>Actions: Read (getParameter and getParameters)  </dd>
</dl>
<p>Review Policy and Give a Policy Name</p>
<h1></h1>
<p><p align="center">
<figure>
  <img src="/images/policy-creation.JPG" alt="Creating a Policy"  class="enableModal">
  <figcaption style="text-align: center;">Figure 10. Creating a Policy.</figcaption>
</figure> 
</p></p>
<h1></h1>
<p>After Creating your Policy, Navigate to your Role tab to Attach the Policy that was created.<br>
Also, Give the Role a name and Save Role.</p>
<h1></h1>
<p><p align="center">
<figure>
  <img src="/images/roles-saved.JPG" alt="Role Summary"  class="enableModal">
  <figcaption style="text-align: center;">Figure 11. Role Summary.</figcaption>
</figure> 
</p></p>
<h1></h1>
<p><strong>Adding the New Role to the Lambda Function</strong></p>
<h1></h1>
<p>Head back to your Function Designer Page, under the Execution Role Section, Select <code>Choose Existing Role</code>. Several Roles are Populated into the existing Roles Field, Search and Select the Role that you recently created for the Lambda Function.  </p>
<p>Our final code.</p>
<div class="highlight"><pre><span></span>import json, sys, requests
import urllib.parse, boto3, random
from twilio.rest import Client
from bs4 import BeautifulSoup as bs

<span class="nv">ssm</span> <span class="o">=</span> boto3.client<span class="o">(</span><span class="s1">&#39;ssm&#39;</span><span class="o">)</span>


def getMessage<span class="o">()</span>:
    <span class="nv">url</span> <span class="o">=</span> <span class="s1">&#39;https://www.serenataflowers.com/pollennation/love-messages/&#39;</span>
    <span class="nv">res</span> <span class="o">=</span> requests.get<span class="o">(</span>url<span class="o">)</span>
    try:
        res.raise_for_status<span class="o">()</span>
    except requests.exceptions.HTTPError:
        sys.exit<span class="o">(</span><span class="m">1</span><span class="o">)</span>
    <span class="nv">soup</span> <span class="o">=</span> bs<span class="o">(</span>res.text, <span class="nv">features</span><span class="o">=</span><span class="s2">&quot;html.parser&quot;</span><span class="o">)</span>
    <span class="nv">listOfMessages</span> <span class="o">=</span> soup.select<span class="o">(</span><span class="s1">&#39;.simple-list li&#39;</span><span class="o">)</span>
    <span class="nv">textMessages</span> <span class="o">=</span> <span class="o">[</span>item.text <span class="k">for</span> item in listOfMessages<span class="o">]</span>
    <span class="nv">randomquote</span> <span class="o">=</span> random.choice<span class="o">(</span>textMessages<span class="o">)</span>
    <span class="k">return</span> randomquote

def _get_request<span class="o">(</span>url, payload<span class="o">)</span>:
    <span class="nv">r</span> <span class="o">=</span> requests.get<span class="o">(</span>url, <span class="nv">params</span><span class="o">=</span>payload<span class="o">)</span>
    try:
        r.raise_for_status<span class="o">()</span>
    except requests.exceptions.HTTPError:
        print<span class="o">(</span><span class="s1">&#39;Error: the Request failed.&#39;</span><span class="o">)</span>
        sys.exit<span class="o">(</span><span class="m">1</span><span class="o">)</span>
    <span class="nv">response</span> <span class="o">=</span> json.loads<span class="o">(</span>r.content.decode<span class="o">(</span><span class="s1">&#39;utf-8-sig&#39;</span><span class="o">))</span>
    <span class="k">return</span> response

def _getParameter<span class="o">(</span>someString<span class="o">)</span>:
    <span class="nv">paramObject</span> <span class="o">=</span> ssm.get_parameter<span class="o">(</span><span class="nv">Name</span><span class="o">=</span>someString, <span class="nv">WithDecryption</span><span class="o">=</span>True<span class="o">)</span>
    <span class="k">return</span> paramObject<span class="o">[</span><span class="s1">&#39;Parameter&#39;</span><span class="o">][</span><span class="s1">&#39;Value&#39;</span><span class="o">]</span>

<span class="nv">transUrl</span> <span class="o">=</span> <span class="s1">&#39;https://translation.googleapis.com/language/translate/v2&#39;</span>
<span class="nv">randomLangUrl</span> <span class="o">=</span> <span class="s1">&#39;https://translation.googleapis.com/language/translate/v2/languages&#39;</span>


def lambda_handler<span class="o">(</span>event, context<span class="o">)</span>:
    try:
        <span class="nv">gtranslateApiKey</span> <span class="o">=</span> _getParameter<span class="o">(</span><span class="s1">&#39;GtranslateApiKey&#39;</span><span class="o">)</span>
        <span class="nv">twiliotoken</span> <span class="o">=</span> _getParameter<span class="o">(</span><span class="s1">&#39;valapptokentwilio&#39;</span><span class="o">)</span>
        <span class="nv">twiliosid</span> <span class="o">=</span> _getParameter<span class="o">(</span><span class="s1">&#39;whatsappsidtwilio&#39;</span><span class="o">)</span>

        <span class="nv">client</span> <span class="o">=</span> Client<span class="o">(</span>twiliosid, twiliotoken<span class="o">)</span>

        <span class="nv">randomLangPayload</span> <span class="o">=</span> <span class="o">{</span><span class="s1">&#39;key&#39;</span>: gtranslateApiKey<span class="o">}</span>

        <span class="nv">destResponse</span> <span class="o">=</span> _get_request<span class="o">(</span>randomLangUrl, randomLangPayload<span class="o">)</span>
        <span class="nv">dest_language</span> <span class="o">=</span> random.choice<span class="o">(</span>destResponse<span class="o">[</span><span class="s1">&#39;data&#39;</span><span class="o">][</span><span class="s1">&#39;languages&#39;</span><span class="o">])</span>

        <span class="nv">transPayload</span> <span class="o">=</span> <span class="o">{</span>
            <span class="s1">&#39;source&#39;</span>: <span class="s1">&#39;en&#39;</span>,
            <span class="s1">&#39;target&#39;</span>: dest_language,
            <span class="s1">&#39;key&#39;</span>: gtranslateApiKey,
            <span class="s1">&#39;q&#39;</span>: urllib.parse.quote<span class="o">(</span><span class="s1">&#39;I Love You&#39;</span><span class="o">)</span>
        <span class="o">}</span>

        <span class="nv">transResponse</span> <span class="o">=</span> _get_request<span class="o">(</span>transUrl, transPayload<span class="o">)</span>
        <span class="nv">msg</span> <span class="o">=</span> transResponse.get<span class="o">(</span><span class="s1">&#39;data&#39;</span><span class="o">)</span>.get<span class="o">(</span><span class="s1">&#39;translations&#39;</span><span class="o">)[</span><span class="m">0</span><span class="o">]</span>.get<span class="o">(</span><span class="s1">&#39;translatedText&#39;</span><span class="o">)</span>

        <span class="nv">msg</span> <span class="o">=</span> translate<span class="o">(</span><span class="s1">&#39;I Love You&#39;</span>, <span class="s1">&#39;en&#39;</span>, dest_language, gtranslateApiKey<span class="o">)</span>
        <span class="nv">randomQuote</span> <span class="o">=</span> getMessage<span class="o">()</span>
        <span class="nv">fulltextmsg</span> <span class="o">=</span> randomQuote + <span class="s2">&quot; \n P.S. &quot;</span> + msg

        <span class="nv">loved_ones</span> <span class="o">=</span> <span class="o">{</span><span class="s1">&#39;seyi&#39;</span>: <span class="s1">&#39;+26878514450&#39;</span><span class="o">}</span>

        <span class="k">for</span> key, value in loved_ones.items<span class="o">()</span>:
            <span class="nv">message</span> <span class="o">=</span> client.messages.create<span class="o">(</span>
                                        <span class="nv">body</span><span class="o">=</span><span class="s2">&quot;Dear &quot;</span> + key + <span class="s2">&quot;,\n&quot;</span> + fulltextmsg,
                                        <span class="nv">from_</span><span class="o">=</span><span class="s1">&#39;whatsapp:+14155238886&#39;</span>,
                                        <span class="nv">to</span><span class="o">=</span><span class="s1">&#39;whatsapp:&#39;</span> + value
                                    <span class="o">)</span>

        <span class="k">return</span> <span class="o">{</span>
            <span class="s1">&#39;statusCode&#39;</span>: <span class="m">200</span>,
            <span class="s1">&#39;body&#39;</span>: message.sid
        <span class="o">}</span>
    except:
        <span class="k">return</span> <span class="o">{</span>
          <span class="s1">&#39;statusCode&#39;</span>: <span class="m">404</span>,
          <span class="s1">&#39;body&#39;</span>: <span class="s1">&#39;Error, Bad Request&#39;</span>
        <span class="o">}</span>
</pre></div>


<p>Save your Function and Test. You should get a success status and a message is sent to the registered Number.  </p>
<h3>Scheduling the Function Execution</h3>
<p>The final part of our project is getting the function to run at scheduled time intervals (similar to using cron to run on our local development environment script). This is done through Lambda Triggers which invoke your function. <br>
We would be using a CloudWatch event Trigger to schedule Our script to run at the specified time.</p>
<h1></h1>
<ul>
<li>On your Designer page, Click on <code>Add a Trigger</code></li>
<li>Select Cloud watch events Trigger</li>
<li>On the Rule Input, Select <code>Create a New Rule</code></li>
<li>Enter a Rule Name</li>
<li>Select the scheduled expression Rule Type</li>
<li>Schedule expression - rate(2 hours)</li>
</ul>
<p>You can create rules that self-trigger on an automated schedule in CloudWatch Events using cron or rate expressions</p>
<h1></h1>
<ul>
<li>Rate Expressions: Syntax rate(int time)</li>
<li>Cron Expressions: same as using Unix Cron Utility</li>
</ul>
<h1></h1>
<p><p align="center">
<figure>
  <img src="/images/step17.PNG" alt="Cloud Watch Event" style="margin: auto;"  class="enableModal">
  <figcaption style="text-align: center;">Figure 12. Cloud Watch Event.</figcaption>
</figure> 
</p></p>
<h1></h1>
<p>The Function should now Run at the scheduled time.</p>
<p><strong>Wrapping Up</strong></p>
<h1></h1>
<p>i hope this articles helps you understand better the steps to deploying a python script on the AWS Lambda service and integrating with other AWS services. Feel free to reach out if you need any help getting your script to work.</p>
<h1></h1>
<p>Ciao  </p>
<h1></h1>
<p>The Source code for the article can be found <a href="https://github.com/seyio91/twiliowhatsappscript" target="_blank">here</a></p>
    <br>
  
  <div class="sharepage">
  <!-- share test -->
  <span style="color: silver;">Share on: </span><div id="share-buttons">
    <div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=https%3A//www.seyiobaweya.tech/articles/2020-02-26/python-deploy-aws-lambda/');"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z"/></svg></div>
    <div class="twitter" title="Share this on Twitter" onclick="window.open('http://twitter.com/home?status=https%3A%2F%2Fwww.seyiobaweya.tech%2Farticles%2F2020-02-26%2Fpython-deploy-aws-lambda%2F');"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/></svg></div>
    <div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.seyiobaweya.tech%2Farticles%2F2020-02-26%2Fpython-deploy-aws-lambda%2F&title=&summary=&source=');"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M4.98 3.5c0 1.381-1.11 2.5-2.48 2.5s-2.48-1.119-2.48-2.5c0-1.38 1.11-2.5 2.48-2.5s2.48 1.12 2.48 2.5zm.02 4.5h-5v16h5v-16zm7.982 0h-4.968v16h4.969v-8.399c0-4.67 6.029-5.052 6.029 0v8.399h4.988v-10.131c0-7.88-8.922-7.593-11.018-3.714v-2.155z"/></svg></div>
    </div>
  </div>    <br>

  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://www.seyiobaweya.tech/tag/python.html">python</a>
      <a href="https://www.seyiobaweya.tech/tag/aws.html">aws</a>
      <a href="https://www.seyiobaweya.tech/tag/webscraping.html">webscraping</a>
      <a href="https://www.seyiobaweya.tech/tag/lambda.html">lambda</a>
    </p>
  </div>




  
  <!-- Pager Goes Here -->
  <ul class="pager">
      <li class="next">
        <a href="https://www.seyiobaweya.tech/articles/2020-02-25/python-love-poem/">Creating a Python Love Poem  <i class="fas fa-angle-double-right"></i></a>
      </li>
  </ul>
  <br>
  <br>
  <br>


  <a class="home-icon" href="https://www.seyiobaweya.tech"><i class="fas fa-home fa-2x"></i></a>

<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'www-seyiobaweya-tech';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
<!-- End Disqus -->
  



  
</article>





    <footer>
<p>&copy;  </p>
<p>    Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p>    </footer>
  </main>
  <!-- <button onclick="topFunction()" id="myBtn" title="Go to top">Top</button> -->
  <a href="#top" class="btn-scroll-to-top tophide" id="js-top" title="Top of page" style="display: block;"><i class="fas fa-angle-double-up fa-4x"></i></i></a>



<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Seyi Obaweya ",
  "url" : "https://www.seyiobaweya.tech",
  "image": "http://localhost:8000/images/site_logo.jpeg",
  "description": "Seyi's Thoughts and Attempts at Writings"
}
</script>

  <!-- Modal Code -->
  
  <!-- Modal Code end -->
<!-- The Modal -->
<div id="myModal" class="modal">
  <span class="closeModal">&times;</span>
  <img class="modal-content" id="modalImg">
  <div id="modalCaption"></div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
  const scrollToTopButton = document.getElementById('js-top');
  const mainbody = document.getElementById('main')
    const scrollFunc = () => {
    // Get the current scroll value
    let y = mainbody.scrollTop;
    if (y > 200) {
      scrollToTopButton.className = "btn-scroll-to-top topshow";
    } else {
      scrollToTopButton.className = "btn-scroll-to-top tophide";
    }
  };
  mainbody.addEventListener('scroll', scrollFunc);
  const scrollToTop = () => {
    // Let's set a variable for the number of pixels we are from the top of the document.
    const c = mainbody.scrollTop;
    if (c > 0) {
      window.requestAnimationFrame(scrollToTop);
      mainbody.scrollTo(0, c - c / 10);
    }
  };
  
  // When the button is clicked, run our ScrolltoTop function above!
  scrollToTopButton.onclick = function(e) {
    e.preventDefault();
    scrollToTop();
  }
  
  // Nav bar media query
  navcol = document.getElementById('navid');
  toggler = document.getElementById('toggler');
  socials = document.getElementById('social')
  var mediaq = window.matchMedia("(max-width: 600px)")
  function removeBlock(mediaq) {
    if (mediaq.matches) { // If media query matches
      // toggler.removeAttribute('style');
      toggler.style.display = "block";
      navcol.style.display = "none";
      socials.setAttribute('style', 'display: none;');
      scrollToTopButton.removeAttribute('style');
      hamburger()
    } else {
      toggler.setAttribute('style', 'display: none;')
      navcol.removeAttribute('style');
      scrollToTopButton.setAttribute('style', 'display: block;')
      socials.removeAttribute('style');
    }
  }
  
  removeBlock(mediaq)
  mediaq.addListener(removeBlock)
  
  
  
  //Hamburger Toggle
  function hamburger(){
    toggler.onclick = function(event) {
      event.stopPropagation()
      showMenu = !showMenu;
      if (showMenu === true){
        navcol.removeAttribute('style');
      } else {
        navcol.style.display = "none"
      }
      toggler.innerHTML = buttonStates[toggler.innerHTML]
    }
    showMenu = false;
  
    buttonStates = {
      '<i class="fas fa-bars"></i> MENU' : '<i class="fas fa-times"></i> MENU',
      '<i class="fas fa-times"></i> MENU' : '<i class="fas fa-bars"></i> MENU'
    }
  
    //Closing Hamburger Outside Menu
    document.addEventListener('click', function(event){
      if (!event.target.contains(navcol) && showMenu && event.target != toggler){
        navcol.style.display = "none";
        toggler.innerHTML = buttonStates[toggler.innerHTML]
        showMenu = false
      }
    })
    
  }
    // Image Click Modal
    var modal = document.getElementById("myModal");

    // Get the image and insert it inside the modal - use its "alt" text as a caption
    var img = document.getElementsByClassName("enableModal");
    var modalImg = document.getElementById("modalImg");
    var captionText = document.getElementById("modalCaption");


    for (let i=0; i<img.length; i++){
        elem = img[i];
        elem.addEventListener('click', (e)=>{
            console.log(e.target.src)
            modal.style.display = "block";
            modalImg.src = e.target.src;
            captionText.innerHTML = e.target.alt;
        })
    }

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("closeModal")[0];

    console.log(span)

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() { 
    modal.style.display = "none";
    }
  });
  </script></body>
</html>